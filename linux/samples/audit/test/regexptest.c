#include <stdio.h>
#include <regex.h>
#include <string.h>
#include <stdlib.h>
#include "regexplib.h"

#define MAX_AUDIT_MESSAGE_LENGTH 8970

static char	buf[MAX_AUDIT_MESSAGE_LENGTH];

static char	*msg_scall = "audit(1632288380.516:296876): arch=c000003e syscall=7 success=yes exit=0 a0=7fd2c8000b60 a1=2 a2=7d0 a3=7fd2cfffe930 items=0 ppid=1 pid=2724 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"GUsbEventThread\" exe=\"/usr/libexec/fwupd/fwupd\" subj=unconfined key=(null)";

static char	*msg_cdir = "audit(1648682333.838:128): cwd=\"/\"";
static char	path[1024];

static char
_h2a(char *p)
{
    int	i, v, val = 0;

    for (i = 0; i < 2; i++) {
	val = val * 16;
	v = *(p + i) - '0';
	if (v >= 0 && v <= 9) {
	    val += v;
	} else {
	    val += (*(p + i) - 'A' + 10);
	}
    }
    return val;
}

#if 0
int
hex2ascii(char *hex, char *asc)
{
    int	idx = 0;
    size_t	sz = 0;
    while (*(hex+idx) != 0) {
	char	ch = _h2a(hex+idx);
	*asc++ = ch;
	if (ch == 0) goto ext;
	idx += 2;
	sz++;
    }
    *asc = 0;
ext:
    return sz;
}
#endif

int
main(int argc, char **argv)
{
    int		rc;
    long	rslt, rslt2, rslt3;

    printf("TEST\n");
    {
	char *arg = "2F7573722F62696E2F656E76202D6920504154483D2F7573722F6C6F63616C2F7362696E3A2F7573722F6C6F63616C2F62696E3A2F7573722F7362696E3A2F7573722F62696E3A2F7362696E3A2F62696E2072756E2D7061727473202D2D6C7362737973696E6974202F6574632F7570646174652D6D6F74642E64203E202F72756E2F6D6F74642E64796E616D69632E6E6577";
	char *arg2 = "7B0A090970617468735B24315D203D20310A097D0A09454E44207B0A0909666F7220287020696E20706174687329207B0A0909096966202873756273747228702C20312C20312920213D20225C222229207B0A0909090923204E6F207370656369616C20636861726163746572732C2065617379210A090909097072696E742070667820700A09090909636F6E74696E75650A0909097D0A0A090909232054686520706174682069732071756F7465642E0A09090970203D20646571756F74652870290A0909096966202870203D3D202222290A09090909636F6E74696E75650A0A09090923204576656E207768656E2061206469726563746F7279206E616D6520697473656C6620646F6573206E6F7420636F6E7461696E0A0909092320616E79207370656369616C20636861726163746572732C2069742077696C6C207374696C6C2062652071756F7465642069660A0909092320616E79206F6620697473202873747269707065642920747261696C696E67207061746820636F6D706F6E656E747320646F2E0A090909232042656361757365206F662074686973207765206D61792068617665207365656E207468652073616D65206469726563746F72790A0909092320626F74682071756F74656420616E6420756E71756F7465642E0A090909696620287020696E207061746873290A09090909232057652068617665207365656E207468652073616D65206469726563746F727920756E71756F7465642C0A090909092320736B69702069742E0A09090909636F6E74696E75650A090909656C73650A090909097072696E742070667820700A09097D0A097D0A0966756E6374696F6E20646571756F746528702C2020202062735F6964782C206F75742C206573632C206573635F6964782C2064656329207B0A09092320536B6970206F70656E696E6720646F75626C652071756F74652E0A090970203D2073756273747228702C2032290A0A09092320496E74657270726574206261636B736C617368206573636170652073657175656E6365732E0A09097768696C6520282862735F696478203D20696E64657828702C20225C5C22292920213D203029207B0A0909096F7574203D206F75742073756273747228702C20312C2062735F696478202D2031290A090909657363203D2073756273747228702C2062735F696478202B20312C2031290A09090970203D2073756273747228702C2062735F696478202B2032290A0A09090969662028286573635F696478203D20696E64657828226162747666725C225C5C222C20657363292920213D203029207B0A090909092320432D7374796C65206F6E652D636861726163746572206573636170652073657175656E63652E0A090909096F7574203D206F75742073756273747228225C615C625C745C765C665C725C225C5C222C0A090909090909206573635F6964782C2031290A0909097D20656C73652069662028657363203D3D20226E2229207B0A09090909232055682D6F682C2061206E65776C696E65206368617261637465722E0A09090909232057652063616E6E6F742072656C6961626C7920707574206120706174686E616D650A090909092320636F6E7461696E696E672061206E65776C696E6520696E746F20434F4D505245504C592C0A090909092320616E6420746865206E65776C696E6520776F756C64206372656174652061206D6573732E0A090909092320536B6970207468697320706174682E0A0909090972657475726E2022220A0909097D20656C7365207B0A0909090923204D7573742062652061205C6E6E6E206F6374616C2076616C75652C207468656E2E0A09090909646563203D20657363202020202020202020202020202A203634202B205C0A0909090920202020202073756273747228702C20312C203129202A203820202B205C0A0909090920202020202073756273747228702C20322C2031290A090909096F7574203D206F757420737072696E746628222563222C20646563290A0909090970203D2073756273747228702C2033290A0909097D0A09097D0A0909232044726F7020636C6F73696E6720646F75626C652071756F74652C206966207468657265206973206F6E652E0A09092320285468657265206973206E6F7420616E7920696620746869732069732061206469726563746F72792C206173206974207761730A09092320616C726561647920737472697070656420776974682074686520747261696C696E67207061746820636F6D706F6E656E74732E290A09096966202873756273747228702C206C656E6774682870292C203129203D3D20225C2222290A0909096F7574203D206F75742073756273747228702C20312C206C656E677468287029202D2031290A0909656C73650A0909096F7574203D206F757420700A0A090972657475726E206F75740A097D";
	size_t	sz;
	sz = hex2ascii(arg, buf);
	printf("hex2ascii = %s (%ld)\n", buf, sz);
	sz = hex2ascii(arg2, buf);
	printf("hex2ascii = %s (%ld)\n", buf, sz);
    }
    {
	char *title = "2F7573722F7362696E2F4E6574776F726B4D616E61676572002D2D6E6F2D6461656D6F6E";
	int	idx = 0;
	size_t	sz;
	printf("title=%s\n", title);
	while (*(title+idx) != 0) {
	    char	ch = _h2a(title+idx);
	    if (ch == 0) break;
	    printf("%c", ch);
	    idx += 2;
	}
	printf("\n");
	sz = hex2ascii(title, buf);
	printf("hex2ascii = %s (%ld)\n", buf, sz);
    }
    
    regex_init(MAX_AUDIT_MESSAGE_LENGTH);
    rc = msg_seqnum(msg_scall, &rslt, &rslt2, &rslt3);
    if (rc == 0) {
	printf("seqnum = %ld time=%ld.%ld\n", rslt, rslt2, rslt3);
    } else {
	printf("seqnum: no match\n");
    }
    rc = msg_syscall(msg_scall, &rslt);
    if (rc == 0) {
	printf("syscall = %ld\n", rslt);
    } else {
	printf("syscall: no match\n");
    }
    rc = msg_cwd(msg_cdir, path);
    printf("rc = %d path = %s\n", rc, path);
    return 0;
}

#if 0
char	errbuf[1024];
/*
 * audit(1632288380.516:296876): arch=c000003e syscall=7 success=yes exit=0 a0=7fd2c8000b60 a1=2 a2=7d0 a3=7fd2cfffe930 items=0 ppid=1 pid=2724 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm="GUsbEventThread" exe="/usr/libexec/fwupd/fwupd" subj=unconfined key=(null)
 */
char	*tpattern[] = {
    
    "audit(1632288380.516:296876): arch=c000003e syscall=7 success=yes exit=0 a0=7fd2c8000b60 a1=2 a2=7d0 a3=7fd2cfffe930 items=0 ppid=1 pid=2724 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=\"GUsbEventThread\" exe=\"/usr/libexec/fwupd/fwupd\" subj=unconfined key=(null)",
    "asdasasdasd",
    "asdasasdasd"
};
char	*regex = "audit([0-9].*:\\([0-9].*\\)):";

int
main(int argc, char **argv)
{
    int		cc, i, j;
    regex_t	preg;
    size_t	sz;
    regmatch_t	pmatch[4];
    
    if ((cc = regcomp(&preg, regex, 0)) < 0) {
	printf("compile error\n");
	sz = regerror(cc, &preg, errbuf, 1024);
	printf("errbuf=%s\n", errbuf);
    }

    for (j = 0; j < 3; j++) {
	memset(pmatch, 0, sizeof(pmatch));
	if ((cc = regexec(&preg, tpattern[j], 4, pmatch, 0)) < 0) {
	    printf("error \n");
	    sz = regerror(cc, &preg, errbuf, 1024);
	    printf("errbuf=%s\n", errbuf);
	} else {
	    char buf[128];
	    if (cc == REG_NOMATCH) {
		printf("no match: %s\n", tpattern[j]);
		continue;
	    }
	    printf("match: %s\n", tpattern[j]);
	    for (i = 0; i < 2; i++) {
		memset(buf, 0, 128);
		strncpy(buf, &tpattern[j][pmatch[i].rm_so],
			pmatch[i].rm_eo - pmatch[i].rm_so);
		printf("\t[%d] %s(%d,%d)\n", i, buf, pmatch[i].rm_so, pmatch[i].rm_eo);
	    }
	    strncpy(buf, &tpattern[j][pmatch[1].rm_so],
			pmatch[1].rm_eo - pmatch[1].rm_so);
	    printf("buf(%s)\n", buf);
	}
    }
    regfree(&preg);
    return 0;
}
#endif
